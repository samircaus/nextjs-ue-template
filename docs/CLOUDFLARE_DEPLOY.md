# Deploying to Cloudflare (OpenNext)

This project uses [@opennextjs/cloudflare](https://opennext.js.org/cloudflare) to run Next.js on Cloudflare Workers. The worker entry point (`.open-next/worker.js`) and assets (`.open-next/assets`) are **generated by the OpenNext build** and are not in git.

## Fix: "Could not find compiled Open Next config" or "worker.js was not found"

Deploy expects the **OpenNext** build output in `.open-next/` (including `.open-next/.build/open-next.config.edge.mjs` and `.open-next/worker.js`). Only **`opennextjs-cloudflare build`** creates these; a plain Next.js build (`next build` / `npm run build`) does not.

**Always run build and deploy in one go** from the project root so the same directory contains `.open-next/` when deploy runs. Use the npm scripts that run both steps.

### Wrong (what causes the error)

| Step   | Wrong command | Why it fails |
|--------|----------------|--------------|
| Build  | `npm run build` or `next build` | Produces `.next/` only; **does not** create `.open-next/worker.js` |
| Deploy | `npx wrangler versions upload` or `npx wrangler deploy` | Looks for `.open-next/worker.js`, which was never created |

### Correct (use these in Cloudflare dashboard)

| Step   | Command |
|--------|--------|
| **Build** | `npx opennextjs-cloudflare build` |
| **Deploy** | `npx opennextjs-cloudflare deploy` (must run after build in the same directory) |

For gradual deployments use **Deploy:** `npx opennextjs-cloudflare upload` instead of `deploy`.

**Locally:** Run build and deploy together so `.open-next/` exists when deploy runs:  
- Production: `npm run deploy`  
- Preview: `npm run deploy:preview`

## Cloudflare Workers Builds (Git integration)

In [Workers Builds](https://developers.cloudflare.com/workers/ci-cd/builds/) → your project → **Settings → Build**:

1. **Build command:** `npx opennextjs-cloudflare build`  
   (not `npm run build` or `next build`)

2. **Deploy command** (production branch, e.g. `main`):  
   `npx opennextjs-cloudflare deploy`  
   (not `npx wrangler deploy`)

3. **Non-production branch deploy command** (other branches):  
   `npx opennextjs-cloudflare upload`  
   **Important:** The default is `npx wrangler versions upload`, which causes the "worker.js was not found" error. You must change this to the OpenNext command so non-main branches also use the OpenNext build output.

4. **Domains and preview environment:**  
   `wrangler.jsonc` defines routes per environment so each deploy goes to the right domain:  
   - **Production:** `npm run deploy` (or `opennextjs-cloudflare build && opennextjs-cloudflare deploy`) → **wknd.edgepatterns.dev**.  
   - **Preview:** `npm run deploy:preview` (or `opennextjs-cloudflare build && opennextjs-cloudflare deploy -- --env preview`) → **wkndpreview.edgepatterns.dev** (logo "WKND Preview").  
   **Always run the OpenNext build before deploy** (the scripts above do both). Deploy alone fails with "Could not find compiled Open Next config" if `.open-next/` is missing or from a different build. Ensure the zone **edgepatterns.dev** exists in your Cloudflare account; change `zone_name` in `wrangler.jsonc` if your zone differs. **`AEM_USE_PREVIEW_URL`** is set by the `preview` env in `wrangler.jsonc`. The app includes `<meta name="urn:adobe:aue:config:preview" content="https://wkndpreview.edgepatterns.dev" />` for Universal Editor.

### If you still see "worker.js was not found"

- **Building from a branch other than `main`?** Change **Non-production branch deploy command** (see step 3 above). That’s the command that runs for non-production branches; its default is `npx wrangler versions upload`.
- In the build log, confirm the **Build** step shows OpenNext (e.g. "opennextjs-cloudflare build" or ".open-next"). If you see only "next build" / "npm run build", the Build command in the dashboard is still wrong or not saved.

## Environment variables

**`.env` files are not loaded in production on Cloudflare.** They are local only and are not deployed. You must set variables in Cloudflare:

| Use case | Where to set |
|----------|----------------|
| **Build** (Next/OpenNext build, SSG, `NEXT_PUBLIC_*` inlining) | [Workers Builds → Build variables and secrets](https://developers.cloudflare.com/workers/ci-cd/builds/configuration/#build-variables-and-secrets) |
| **Runtime** (Worker at request time) | [Workers → Settings → Variables and Secrets](https://developers.cloudflare.com/workers/configuration/environment-variables/) |

Set the same names you use in `.env`: `AEM_PUBLISH_URL`, `AEM_PREVIEW_URL`, `AEM_AUTHOR_URL`, `AEM_PREVIEW_MODE`, `AEM_USE_PREVIEW_URL`, `AEM_UE_CONNECTION`, etc. (see `.env.example` and `wrangler.jsonc`). Use **Secrets** for sensitive values (they cannot be read back from the dashboard). To avoid deployments removing existing vars: `opennextjs-cloudflare deploy -- --keep-vars`. If neither Publish nor Preview URL is set, the app renders fallback text instead of AEM content.

Details: [OpenNext env vars (production)](https://opennext.js.org/cloudflare/howtos/env-vars#production).

## Local deploy

```bash
npm run deploy
```

This runs `opennextjs-cloudflare build` then `opennextjs-cloudflare deploy` (see `package.json`).

## Preview locally (Workers runtime)

```bash
npm run preview
```

Builds and runs the worker locally with `opennextjs-cloudflare preview`.
